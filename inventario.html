import streamlit as st
from pyairtable import Api

st.set_page_config(layout="wide")
st.title("ğŸ•µï¸â€â™‚ï¸ Prueba de ConexiÃ³n Directa a Airtable")
st.write("---")
st.info("Intentando conectar con las llaves secretas guardadas en Streamlit Cloud...")

try:
    # 1. Intenta usar los 'secrets' para crear la conexiÃ³n
    api = Api(st.secrets["AIRTABLE_TOKEN"])
    st.success("âœ… Â¡API Token de Airtable leÃ­do correctamente!")

    table = api.table(st.secrets["BASE_ID"], st.secrets["TABLE_NAME"])
    st.success("âœ… Â¡ConexiÃ³n a la Base y a la Tabla exitosa!")
    st.write(f"**ID de la Base (BASE_ID):** `{st.secrets['BASE_ID']}`")
    st.write(f"**ID de la Tabla (TABLE_NAME):** `{st.secrets['TABLE_NAME']}`")
    st.write("---")
    
    # 2. Intenta leer TODOS los registros de la tabla USANDO LA NUEVA VISTA
    st.info("Ahora, intentando leer todos los registros desde la vista 'API_View'...")
    # --- Â¡ESTA ES LA LÃNEA MODIFICADA! ---
    all_records = table.all(view="API_View")
    st.success(f"âœ… Â¡Lectura de datos completada! Se encontraron {len(all_records)} registros.")
    
    # 3. Muestra los primeros 5 registros para confirmar
    st.write("A continuaciÃ³n se muestran los primeros 5 registros encontrados:")
    st.json(all_records[:5])
    
    # Muestra los ÃšLTIMOS 5 registros para verificar los datos nuevos
    st.write("Y estos son los ÃšLTIMOS 5 registros:")
    st.json(all_records[-5:])


except Exception as e:
    st.error("ğŸš¨ Â¡FALLÃ“ LA CONEXIÃ“N O LA LECTURA DE DATOS! ğŸš¨")
    st.write("El error detallado es el siguiente. Por favor, envÃ­a una captura de este error.")
    # st.exception() muestra el error de una forma muy clara
    st.exception(e)

